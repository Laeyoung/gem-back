name: Run Tests on PR

on:
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-comment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        id: run-tests
        run: |
          # Run tests and pipe output to both console and a file for capture
          output=$(npm test 2>&1)
          exit_code=$?
          
          # Store output in a temporary file to handle multiline safely
          echo "$output" > test_output.txt
          
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          
          # Exit with the original exit code so the step fails if tests failed
          # We don't want to exit immediately here because we want to post the comment first.
          # Actually, if we want to post a comment REGARDLESS of success/failure, we should use 'if: always()' in the next step.
          # But we also want this specific step to eventually fail the job if tests failed.
          # So we will let this step succeed for now but mark the failure status for later, 
          # OR we can use `continue-on-error: true` and check outcome in the next step.
          # Let's use `continue-on-error: true` for this step.
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always() # Run even if tests failed (which they technically won't cause of continue-on-error, but good practice)
        with:
          script: |
            const fs = require('fs');
            
            let testOutput = '';
            try {
              testOutput = fs.readFileSync('test_output.txt', 'utf8');
            } catch (e) {
              testOutput = 'Failed to read test output.';
            }

            // Truncate output if it's too long (GitHub comment limit is 65536 chars)
            const MAX_LENGTH = 60000;
            if (testOutput.length > MAX_LENGTH) {
              testOutput = testOutput.substring(0, MAX_LENGTH) + '\n... (output truncated)';
            }

            const stepOutcome = '${{ steps.run-tests.outcome }}'; // 'success' or 'failure' (from continue-on-error perspective it is success, but we check exit code if we did that manually)
            // Wait, continue-on-error: true makes outcome 'success' but conclusion 'failure' usually? 
            // Better checking: use the process exit code captured or simply checking the step outcome handling.
            // With continue-on-error: true, steps.run-tests.outcome will be 'failure' if command failed, but the job continues.
            
            const outcome = '${{ steps.run-tests.outcome }}';
            const success = outcome === 'success';
            
            const icon = success ? '✅' : '❌';
            const title = success ? 'Tests Passed' : 'Tests Failed';
            
            const body = `### ${icon} ${title}
            
            <details>
            <summary>Test Output</summary>
            
            \`\`\`
            ${testOutput}
            \`\`\`
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail workflow if tests failed
        if: steps.run-tests.outcome != 'success'
        run: exit 1
